dist: precise
sudo: required
language: php
services:
  - mysql
install:
  - phpenv config-rm xdebug.ini || return 0
  - composer install --no-dev -d ${TRAVIS_BUILD_DIR}/src/lib/Shopgate/cloud-integration-magento-oauth2
  # handles node update, do not move to script
  - rm -rf ~/.nvm && git clone https://github.com/creationix/nvm.git ~/.nvm && (cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`) && source ~/.nvm/nvm.sh && nvm install 8.4

php:
  - 5.3 #todo-sg: upgrade oAuth extension to v1.11 when it is available
  - 5.4
  - 5.5
  - 5.6

before_script:
  - if [[ "$TRAVIS_TAG" ]] || [ "$TRAVIS_EVENT_TYPE" != "push" ]; then
      chmod +x ./tests/postman/test_env_setup.sh;
      ./tests/postman/test_env_setup.sh;
    fi
script:
  - if [[ "$TRAVIS_TAG" ]] || [ "$TRAVIS_EVENT_TYPE" != "push" ]; then
      chmod +x ./tests/postman/magento_setup.sh;
      ./tests/postman/magento_setup.sh;
      cd ${TRAVIS_BUILD_DIR}/tests/postman/newman;
      newman run ./collection.json -g ./globals.json --insecure --reporters json,cli --reporter-json-export verbose-report.json --reporter-cli-no-assertions --color --global-var "domain=http://travis.dev/${MAGE_FOLDER}/" --global-var "username=${USER1_EMAIL}" --global-var "password=${USER_PASS}" --global-var "mage_type=${MAGE_TYPE}" --global-var "client_id=${CFG_API_CUSTOMER_NUMBER}-${CFG_API_SHOP_NUMBER}" --global-var "client_secret=${CFG_API_KEY}";
    fi
after_failure:
  # one can check for a link in the terminal as this report file is uploaded to that link
  - curl --upload-file ./verbose-report.json https://transfer.sh/verbose-report.json
  - sudo less -FX /var/log/apache2/error.log

jobs:
  include:
    - stage: deploy
      php: 5.6
      before_script:
        - sudo apt-get install xmlstarlet
      script:
        - if [[ "$TRAVIS_TAG" ]]; then
            ./release/build_release_package.sh;
          fi
      provider: releases
      api_key: ${GITHUB_TOKEN}
      file: cloud-integration-magento-${TRAVIS_TAG}.tgz
      skip_cleanup: true
      on:
        tags: true

notifications:
  slack:
    secure: p2iPDFozZji1TiOopmiXiZHiNmPFTRFKzrjiG+wxyPnAJ3BWzCGT1LDYLYnDL2CJY/uk3ZhUuX0QBZLAVaJTdZVMI9IrzD2QOii4VywMFJcA80zh5r7L3ReRYy9yBY1RBh2qR/Lbu9n+Iu4kKcKAfjjNkvBc/WSQo9c7hYGsRgeLYANPuaCW8FpNCWfDODtWaFwXQ7WWOfCYEdABDjthGhtaekN3El2CjQulWrUgMLCs1EQrjO4dm8n9/C840CaLlzsKmb7lNmqSj9oHQBUhmkqfm5VTJqP9Vb12X1AjY/Mu+9BfyUT4jBWAiqxPKJNwzuwNqeqXwc0OlRZaleyWKtIVurUQiXJVjiskOHpkjZ/vyjU/oLFigbiUDgmiCQVNsoJT1l6JjKjOSGuW28PXmDJWZf6MLM1jfh7zUqvQAZJkCr22dc8pEX6SzirxHFs7zdwAgRWxMkIaC7JUnbM+OCh1D+BqwCgmvqYrkBmpaX9/F8AySz5ZJa0Cz/BMUvx7QQOxW21D+BSkggR2ohkDQe2FCrg0iVSKCjD24P28TwncpO17kF+dIt9qF2zS/PTWt8mvwTEg0SsonU3cDM+a3jGak8AK9s6+YZaBdPdlZhyn9TI3Cx3tomha3juJU4wAH8jljzn6RxdTdEvdsqaEkWbzJRB+gKgKBlBFewj0HsQ=
    on_success: change
    on_failure: always

addons:
  hosts:
    - travis.dev

env:
  global:
    WEB_PATH="/var/www"
    CFG_API_CUSTOMER_NUMBER="11223344"
    CFG_API_SHOP_NUMBER="12345"
    CFG_API_KEY="11111111111111111111"
    USER1_EMAIL="konstantin.kiritsenko+1@shopgate.com"
    USER_PASS="test123"
  matrix:
    - MAGE_FOLDER="mage_ce_1702" MAGE_PACKAGE="sg-magento-mirror-1.7.0.2" MAGE_TYPE="CE"
    - MAGE_FOLDER="mage_ce_1810" MAGE_PACKAGE="sg-magento-mirror-1.8.1.0" MAGE_TYPE="CE" MAGE_LOCALE="en_US"
    - MAGE_FOLDER="mage_ce_1936" MAGE_PACKAGE="magento-mirror-1.9.3.6" MAGE_TYPE="CE"
    - MAGE_FOLDER="mage_ee_11202" MAGE_PACKAGE="magento-1.12.0.2" MAGE_TYPE="EE" MAGE_LOCALE="en_US"
    - MAGE_FOLDER="mage_ee_11302" MAGE_PACKAGE="magento-1.13.0.2" MAGE_TYPE="EE"
    - MAGE_FOLDER="mage_ee_11437" MAGE_PACKAGE="magento-1.14.3.7" MAGE_TYPE="EE"
